<!DOCTYPE html><html lang='en-US'><meta charset='UTF-8'>
<html>
  <head>
    <title>Asset Tracker Device Evaluation UI</title>
    <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css' integrity='sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk' crossorigin='anonymous'>
    <link href='https://fonts.googleapis.com/css?family=Abel' rel='stylesheet'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <style>
      .center {margin-left: auto; margin-right: auto; margin-bottom: auto; margin-top: auto}
      body {background-color: #3366cc}
      textarea {height: auto; font-family: Abel}
      button {font-family: Abel}
      p {color: white; font-family: Abel}
      h1 {color: #ffffff; font-family: Abel; font-weight:bold; padding: 20px}
      h2 {color: #99ccff; font-family: Abel; font-weight:bold; padding: 20px}
      h4 {color: white; font-family: Abel}
      h5 {color: white; font-family: Abel}
      a:link {color: white; font-family: Abel}
      a:visited {color: #cccccc; font-family: Abel}
      a:hover {color: black; font-family: Abel}
      a:active {color: black; font-family: Abel}

      .alert-inactive {color: #7a7a7a; transition: 1s ease-out}
      .alert-active {color: #ea4d4d; transition: 1s ease-in; font-size: 18px; font-weight:bold}
    </style>
  </head>
  <body>
    <h1 class='text-center'>Asset Tracker Device Evaluation UI</h1>
    <div class='container' style='padding: 20px'>
      <div style='border: 2px solid white'>
        <h2 class='text-center'>Latest data from the device</h2>
        <div class='container' style='min-width: 50%; width: fit-content; max-width: 98%'>
          <h4 class='ld-temperature text-center'>Temperature: <span></span>&deg;C</h4>
          <h4 class='ld-battery-level text-center'>Battery Level: <span></span>%</h4>
          <div class='container' style='padding: 10px; border: 2px solid #99ccff'>
            <h4 class='text-center'>Location</h4>
            <h5 class='ld-loc-type text-center'>Type: <span></span></h5>
            <h5 class='ld-loc-lat text-center'>Latitude: <span></span>&deg;</h5>
            <h5 class='ld-loc-lng text-center'>Longitude: <span></span>&deg;</h5>
            <h5 class='ld-loc-acc text-center'>Accuracy: <span></span>m</h5>
            <p class='ld-loc-ts text-center'>Timestamp: <span></span></p>
          </div>
          <div class='container' style='margin-top: 10px; padding: 10px; border: 2px solid #99ccff'>
            <h4 class='text-center'>Alerts</h4>
            <div class='ld-alerts grid-container' style='display: grid; margin-left: auto; margin-right: auto; grid-template-columns: 50% 50%'>
              <p class='ld-alerts-temperatureHigh alert-inactive text-center' style='grid-column-start: 1; grid-column-end: 1'>Temperature high</p>
              <p class='ld-alerts-temperatureLow alert-inactive text-center' style='grid-column-start: 2; grid-column-end: 2'>Temperature low</p>

              <p class='ld-alerts-motionStarted alert-inactive text-center' style='grid-row-start: 2; grid-row-end: 2; grid-column-start: 1; grid-column-end: 1'>Motion started</p>
              <p class='ld-alerts-motionStopped alert-inactive text-center' style='grid-row-start: 2; grid-row-end: 2; grid-column-start: 2; grid-column-end: 2'>Motion stopped</p>

              <p class='ld-alerts-geofenceEntered alert-inactive text-center' style='grid-row-start: 3; grid-row-end: 3; grid-column-start: 1; grid-column-end: 1'>Geofence entered</p>
              <p class='ld-alerts-geofenceExited alert-inactive text-center' style='grid-row-start: 3; grid-row-end: 3; grid-column-start: 2; grid-column-end: 2'>Geofence exited</p>

              <p class='ld-alerts-batteryLow alert-inactive text-center' style='grid-row-start: 4; grid-row-end: 4; grid-column-start: 1; grid-column-end: 1'>Battery low</p>
              <p class='ld-alerts-shockDetected alert-inactive text-center' style='grid-row-start: 4; grid-row-end: 4; grid-column-start: 2; grid-column-end: 2'>Shock detected</p>

              <p class='ld-alerts-tamperingDetected alert-inactive text-center' style='grid-row-start: 5; grid-row-end: 5; grid-column-start: 1; grid-column-end: 1'>Tampering detected</p>
              <p class='ld-alerts-repossessionActivated alert-inactive text-center' style='grid-row-start: 5; grid-row-end: 5; grid-column-start: 2; grid-column-end: 2'>Repossession activated</p>
            </div>
            <p class='text-right' style='margin: 0px; font-size: 14px'>* active alerts are <span class='alert-active' style='font-size: inherit'>red</span></p>
          </div>
          <p class='ld-timestamp text-center' style='margin-top: 10px'>Data timestamp: <span></span></p>
        </div>
      </div>
    </div>
    <div class='container' style='padding: 20px'>
      <div class='alerts-history container' style='border: 2px solid white; padding: 20px; padding-top: 0px'>
        <h2 class='text-center'>Alerts history</h2>
        <div class='alerts-history-grid' style='margin-left: auto; margin-right: auto; width: fit-content; padding-top: 0px'>
        </div>
      </div>
    </div>
    <div class='container' style='padding: 20px'>
      <div style='border: 2px solid white'>
        <h2 class='text-center'>Configuration</h2>
        <div class='cfg grid-container' style='display: grid; grid-template-columns: auto auto auto; padding: 20px; padding-top: 0px'>
          <h4 class='text-center' style='grid-column-start: 20; grid-column-end: 26; margin: 10px'>Get</h4>
          <h4 class='text-center' style='grid-column-start: 74; grid-column-end: 80; margin: 10px'>Set</h4>
          <textarea class='received-cfg' readonly style='height: 600px; min-height: 300px; grid-column-start: 1; grid-column-end: 46; grid-row-start: 2; grid-row-end: 102'></textarea>
          <button type='submit' class='copy-cfg btn btn-light btn-sm' style='font-size: 20px; grid-column-start: 47; grid-column-end: 54; grid-row-start: 51'>&rarr;</button></p>
          <textarea class='new-cfg' style='resize: none; grid-column-start: 55; grid-column-end: 100; grid-row-start: 2; grid-row-end: 102'></textarea>
          <button type='submit' class='request-cfg btn btn-light btn-sm' style='grid-column-start: 20; grid-column-end: 26; margin-top: 10px'>Request cfg</button></p>
          <button type='submit' class='send-cfg btn btn-light btn-sm' style='grid-column-start: 74; grid-column-end: 80; margin-top: 10px'>Send cfg</button></p>
        </div>
      </div>
    </div>
    <div class='container' style='padding: 20px'>
      <div style='border: 2px solid white'>
        <h2 class='text-center'>Tokens</h2>
        <div class='tokens'>
          <p class='text-center'>U-blox Assist Now token<br /><input class='ublox-token' style='width:200px'></input><br />
          <p class='text-center'>Google Geolocation API key<br /><input class='gmaps-token' style='width:200px'></input><br />
          <button type='submit' class='set-tokens btn btn-light btn-sm' style='font-family:Abel; margin-top: 10px'>Set tokens</button></p>
        </div>
      </div>
    </div>
    <div class='container' style='padding: 20px'>
      <div style='border: 2px solid white'>
        <h2 class='text-center'>Cloud settings</h2>
        <div class='cloud-settings'>
          <p class='text-center'>Cloud REST API URL<br /><input class='cloud-url' style='width:200px'></input><br />
          <p class='text-center'>Cloud REST API Username<br /><input class='cloud-user' style='width:200px'></input><br />
          <p class='text-center'>Cloud REST API Password<br /><input type='password' class='cloud-pass' style='width:200px'></input><br />
          <button type='submit' class='set-cloud-settings btn btn-light btn-sm' style='font-family:Abel; margin-top: 10px'>Set cloud settings</button></p>
        </div>
      </div>
    </div>
    <script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>
    <script>
      // The period of getting data from the device, in msec
      const GET_DATA_PERIOD = 30000;
      // Imp-agent data endpooint
      const DATA_ENDPOINT = '/web-ui/data';
      // Imp-agent cfg endpooint
      const CFG_ENDPOINT = '/cfg';
      // Imp-agent tokens endpooint
      const TOKENS_ENDPOINT = '/web-ui/tokens';
      // Imp-agent cloud settings endpooint
      const CLOUD_SETTINGS_ENDPOINT = '/web-ui/cloud-settings';
      // Store the agent URL
      const AGENT_URL = window.location.href;

      // Here the received from the agent configuration will be saved
      var receivedCfg;

      // Buttons for operations with configuration
      $('.cfg button.request-cfg').click(getCfg);
      $('.cfg button.copy-cfg').click(copyCfg);
      $('.cfg button.send-cfg').click(sendCfg);

      // Buttons for operations with tokens
      $('.tokens button.set-tokens').click(setTokens);

      // Buttons for operations with cloud settings
      $('.cloud-settings button.set-cloud-settings').click(setCloudSettings);

      // Request data and display it
      get(DATA_ENDPOINT, onDataReceived);

      // Request cfg from the agent
      function getCfg(_) {
        get(CFG_ENDPOINT, onCfgReceived);
      }

      // Copy cfg (excluding 'description' section) from 'get' field to 'set' field (on the page)
      function copyCfg(_) {
        if (receivedCfg) {
          let cutCfg = JSON.parse(receivedCfg);
          delete cutCfg.description;
          $('.cfg textarea.new-cfg').val(JSON.stringify(cutCfg, null, 4));
        }
      }

      // Send the cfg composed in 'set' field on the page to the agent
      function sendCfg(_) {
        let newCfg = $('.cfg textarea.new-cfg').val();

        try {
          JSON.parse(newCfg);
        } catch (err) {
          alert('The new cfg is not a valid JSON: ' + err);
          return;
        }

        let onCfgSent = function(err, data) {
          if (err) {
            alert('Failed to send cfg: an error occurred (' + err.responseText + ')');
            console.log(err);
          } else {
            alert('Cfg sent successfully');
          }
        };

        patch(CFG_ENDPOINT, newCfg, onCfgSent);
      }

      // Callback called when cfg received from the agent.
      // Update the display: configuration
      function onCfgReceived(err, cfg) {
        if (err) {
          console.log('Could not get cfg');
          console.log(err);
          return;
        }

        receivedCfg = JSON.stringify(JSON.parse(cfg), null, 4);
        $('.cfg textarea.received-cfg').val(receivedCfg);
      }

      // Callback called when data received from the device.
      // Update the display: latest data and alerts history
      function onDataReceived(err, data) {
        // Auto-update every 10 sec
        setTimeout(function() {
          get(DATA_ENDPOINT, onDataReceived);
        }, GET_DATA_PERIOD);

        if (err) {
          console.log('Could not get data');
          console.log(err);
          return;
        }

        displayLatestData(data.latestData);
        displayAlertsHistory(data.alertsHistory);
      }

      // Update the display (latest data) when we receive data from the device
      function displayLatestData(data) {
        // Update the data from sensors
        $('.ld-temperature span').text(data.sensors.temperature.toFixed(2));
        $('.ld-battery-level span').text(data.sensors.batteryLevel.toFixed(2));

        // Update location info
        $('.ld-loc-type span').text(data.location.type);
        $('.ld-loc-lat span').text(data.location.lat);
        $('.ld-loc-lng span').text(data.location.lng);
        $('.ld-loc-acc span').text(data.location.accuracy.toFixed(2));
        let date = new Date(data.location.timestamp * 1000);
        $('.ld-loc-ts span').text(date.toUTCString());

        // Display the time and date of the data creation
        date = new Date(data.timestamp * 1000);
        $('.ld-timestamp span').text(date.toUTCString());

        // Reset all alerts (make them 'inactive')
        $('.ld-alerts p').each(function(index, value) {
          $(this).removeClass('alert-active');
        });

        // Set active alerts to the 'active' state
        data.alerts.forEach(alert => {
          $('.ld-alerts p.ld-alerts-' + alert).addClass('alert-active');
        });
      }

      // Update the display (alerts history) when we receive data from the device
      function displayAlertsHistory(alerts) {
        $('.alerts-history-grid p').remove();

        let alertToText = function(alert) {
          switch (alert) {
            case 'temperatureHigh': return 'Temperature high';
            case 'temperatureLow': return 'Temperature low';
            case 'motionStarted': return 'Motion started';
            case 'motionStopped': return 'Motion stopped';
            case 'geofenceEntered': return 'Geofence entered';
            case 'geofenceExited': return 'Geofence exited';
            case 'batteryLow': return 'Battery low';
            case 'shockDetected': return 'Shock detected';
            case 'tamperingDetected': return 'Tampering detected';
            case 'repossessionActivated': return 'Repossession activated';
            default: return alert;
          }
        };

        alerts.forEach(alertData => {
          let date = new Date(alertData.ts * 1000).toUTCString();
          let alertText = alertToText(alertData.alert);
          let newEl = `<p class='text-left' style='margin: 0px'>${date}: ${alertText}</p>`;
          $('.alerts-history-grid').append(newEl);
        });
      }

      // Send the tokens to the agent
      function setTokens(_) {
        let ubloxToken = $('.tokens input.ublox-token').val();
        let gmapsToken = $('.tokens input.gmaps-token').val();
        let payload = {};

        ubloxToken.length && (payload.ublox = ubloxToken);
        gmapsToken.length && (payload.gmaps = gmapsToken);

        if (Object.keys(payload).length > 0) {
          let onTokensSet = function(err, data) {
            if (err) {
              alert('Failed to set token(s): an error occurred');
              console.log(err);
            } else {
              alert('Token(s) set successfully');
            }
          };

          patch(TOKENS_ENDPOINT, JSON.stringify(payload), onTokensSet);
        } else {
          alert('Type in, at least, one token');
        }
      }

      // Send cloud settings to the agent
      function setCloudSettings(_) {
        let url = $('.cloud-settings input.cloud-url').val();
        let user = $('.cloud-settings input.cloud-user').val();
        let pass = $('.cloud-settings input.cloud-pass').val();

        if (url.length * user.length * pass.length === 0) {
          alert('Type in all cloud settings, please');
          return;
        }

        let payload = {
          'url': url,
          'user': user,
          'pass': pass
        };

        let onCloudSet = function(err, data) {
          if (err) {
            alert('Failed to set cloud settings: an error occurred');
            console.log(err);
          } else {
            alert('Cloud settings have been set successfully');
          }
        };

        patch(CLOUD_SETTINGS_ENDPOINT, JSON.stringify(payload), onCloudSet);
      }

      // GET request to the agent
      function get(path, callback) {
        $.ajax({
          url : AGENT_URL + path,
          type: 'GET',
          success : function(data) {
            callback(null, data);
          },
          error : function(err) {
            callback(err, null);
          }
        });
      }

      // PATCH request to the agent
      function patch(path, data, callback = null) {
        $.ajax({
          url : AGENT_URL + path,
          data: data,
          type: 'PATCH',
          headers : {
              'Content-Type' : 'application/json'
          },
          success : function(data) {
            callback && callback(null, data);
          },
          error : function(err) {
            callback && callback(err, null);
          }
        });
      }
    </script>
  </body>
</html>